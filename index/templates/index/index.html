{%load static%}
<!doctype html>
<html>

<head>
    <title>WebRTC: Still photo capture demo</title>
    <meta charset='utf-8'>
    <script src="{%static 'js/index.js' %}">
    </script>
</head>

<body>
    <script>
        const URL = 'get_video';
        let div = document.createElement('div');
        div.id = 'messages';
        let start = document.createElement('button');
        start.id = 'start';
        start.innerHTML = 'Start';
        let stop = document.createElement('button');
        let output = document.createElement('video')
        output.id = 'output'
        output.muted = true;
        stop.id = 'stop';
        stop.innerHTML = 'Stop';
        document.body.appendChild(div);
        document.body.appendChild(start);
        document.body.appendChild(stop);
        document.body.appendChild(output);
        navigator.mediaDevices.getUserMedia({ audio: true, video: true })
            .then(stream => {
                const mediaRecorder = new MediaRecorder(stream);

                document.querySelector('#start').addEventListener('click', function () {
                    mediaRecorder.start();
                    output.srcObject=stream
                    output.play()
                });
                let audioChunks = [];
                mediaRecorder.addEventListener("dataavailable", function (event) {
                    audioChunks.push(event.data);
                });

                document.querySelector('#stop').addEventListener('click', function () {
                    mediaRecorder.stop();
                    output.pause()
                });

                mediaRecorder.addEventListener("stop", function () {
                    const audioBlob = new Blob(audioChunks, {
                        type: "video/webm"
                    });

                    let fd = new FormData();
                    fd.append('voice', audioBlob);
                    sendVoice(fd);
                    audioChunks = [];
                });
            });

        async function sendVoice(form) {
            let promise = await fetch(URL, {
                method: 'POST',
                body: form
            });
            if (promise.ok) {
                let response = await promise.json();
                console.log(response.data);
                audio.src = response.data;
                audio.controls = true;
                audio.autoplay = true;
                document.querySelector('#messages').appendChild(audio);
            }
        }
    </script>
    сука
</body>

</html>